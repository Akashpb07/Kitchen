<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Essentials</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Basic Reset & Body Styling */
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #f4f7f6; /* Light gray background */
            color: #333;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            background-color: #4CAF50; /* Green primary color */
            color: #fff;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-header h1 {
            margin: 0;
            font-size: 1.5em; /* Adjust for mobile readability */
            font-weight: 500;
        }

        .list-navigation {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            gap: 5px;
            flex-wrap: wrap; /* Allow buttons to wrap */
        }

        .list-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s, border-color 0.2s;
            white-space: nowrap; /* Prevent text wrapping */
        }

        .list-btn.active, .list-btn:hover {
            background-color: #fff;
            color: #4CAF50;
            border-color: #fff;
        }

        /* Main Container */
        .app-container {
            flex-grow: 1; /* Allows main content to fill available space */
            padding: 15px 20px 120px; /* Padding for bottom navbar */
            max-width: 600px; /* Max width for larger screens */
            margin: 0 auto; /* Center content */
            width: 100%; /* Ensure it takes full width on small screens */
            box-sizing: border-box; /* Include padding in width */
        }

        /* Item Categories */
        .item-category {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .item-category h2 {
            font-size: 1.2em;
            color: #4CAF50;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            font-weight: 500;
        }

        /* Item Row Styling */
        .item-row {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #f0f0f0;
            position: relative; /* For the delete button positioning */
        }

        .item-row:last-child {
            border-bottom: none;
        }

        .item-checkbox-label {
            display: flex;
            align-items: center;
            flex-grow: 1; /* Allows label to take available space */
            cursor: pointer;
        }

        /* Custom Checkbox Styling (hide default, create custom) */
        .item-checkbox {
            /* Hide default checkbox */
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .item-checkbox + .custom-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 4px;
            display: inline-block;
            margin-right: 10px;
            position: relative;
            transition: background-color 0.2s, border-color 0.2s;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .item-checkbox:checked + .custom-checkbox {
            background-color: #4CAF50;
            border-color: #4CAF50;
        }

        .item-checkbox:checked + .custom-checkbox::after {
            content: '\2713'; /* Checkmark character */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
        }

        .item-name {
            font-size: 1em;
            margin-right: 10px; /* Space between name and price */
            color: #555;
            font-weight: 400;
        }

        .price-input-wrapper {
            display: flex;
            align-items: center;
            position: relative;
            margin-left: auto; /* Push to the right */
        }

        .currency {
            font-size: 0.9em;
            color: #666;
            margin-right: 5px;
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .item-price-input {
            width: 80px; /* Fixed width for price input */
            padding: 8px 8px 8px 25px; /* Left padding for currency symbol */
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
            text-align: right; /* Align numbers to the right */
            -moz-appearance: textfield; /* Remove number input arrows for Firefox */
        }

        /* Hide arrows for Chrome, Safari, Edge */
        .item-price-input::-webkit-outer-spin-button,
        .item-price-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }


        /* Add New Item Section */
        .add-item-section {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .add-item-form {
            display: flex;
            flex-wrap: wrap; /* Allows wrapping on smaller screens */
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .add-item-form input[type="text"],
        .add-item-form input[type="number"] {
            flex-grow: 1; /* Allow inputs to grow */
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            min-width: 120px; /* Minimum width before wrapping */
        }

        .add-item-form .price-input-wrapper {
            flex-grow: 1;
            min-width: 100px;
            margin-left: 0; /* Reset margin for this context */
        }

        .add-item-form .price-input-wrapper .currency {
            left: 12px; /* Adjust for standard padding */
        }

        .add-item-form input[type="number"] {
            padding-left: 35px; /* Space for currency symbol */
        }


        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .primary-btn {
            background-color: #4CAF50;
            color: white;
        }

        .primary-btn:hover {
            background-color: #45a049;
        }

        /* Custom Items List */
        .custom-items-list {
            margin-top: 10px;
        }

        .custom-item-row {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Space between item and delete */
            padding: 10px 0;
            border-bottom: 1px dashed #f0f0f0;
        }

        .custom-item-row:last-child {
            border-bottom: none;
        }

        .custom-item-row .item-checkbox-label {
            flex-grow: 1;
        }

        .delete-item-btn {
            background: none;
            border: none;
            color: #ff4d4f; /* Red for delete */
            font-size: 1.2em;
            cursor: pointer;
            margin-left: 10px;
            padding: 5px; /* Increase tap area */
            border-radius: 50%; /* Make it round */
            transition: background-color 0.2s ease;
        }

        .delete-item-btn:hover {
            background-color: #ffe8e6;
        }

        /* Footer (Fixed Navbar) */
        .app-footer {
            background-color: #333;
            color: #fff;
            padding: 15px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .total-price-display {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 10px;
            color: #ffe082; /* Light yellow for total */
        }

        .total-price-display .currency {
            position: static; /* Override absolute positioning */
            transform: none;
            font-size: 1em; /* Match parent */
            color: inherit; /* Inherit color from parent */
            margin-right: 0;
        }

        .bottom-navbar {
            display: flex;
            justify-content: space-around;
            width: 100%;
        }

        .nav-btn {
            background: none;
            border: none;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8em;
            padding: 8px 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-radius: 8px;
            min-width: 80px; /* Ensure buttons are wide enough */
        }

        .nav-btn:hover {
            background-color: #555;
        }

        .nav-btn i {
            font-size: 1.4em;
            margin-bottom: 5px;
        }

        /* Media Queries for responsiveness */
        @media (max-width: 480px) {
            .app-header h1 {
                font-size: 1.3em;
            }

            .app-container {
                padding: 10px 15px 120px; /* Adjust padding for smaller screens */
            }

            .item-category h2 {
                font-size: 1.1em;
            }

            .item-name {
                font-size: 0.95em;
            }

            .item-price-input {
                width: 70px; /* Slightly smaller input for compact screens */
                padding: 6px 6px 6px 20px;
                font-size: 0.9em;
            }

            .add-item-form {
                flex-direction: column; /* Stack inputs vertically on very small screens */
                align-items: stretch;
            }

            .add-item-form input[type="text"],
            .add-item-form input[type="number"],
            .add-item-form .price-input-wrapper {
                min-width: unset; /* Remove min-width when stacked */
                width: 100%;
                box-sizing: border-box; /* Ensure padding is included */
            }

            .add-item-form .price-input-wrapper .currency {
                left: 12px;
            }

            .nav-btn {
                font-size: 0.75em;
                min-width: 70px;
            }

            .nav-btn i {
                font-size: 1.2em;
            }

            .total-price-display {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <h1>Home Essentials</h1>
        <div class="list-navigation" id="listNavigation">
            </div>
    </header>

    <main class="app-container">
        <section class="item-category" id="appliances-category">
            <h2>Appliances</h2>
            </section>

        <section class="item-category" id="kitchen-category">
            <h2>Kitchen & Utensils</h2>
            </section>

        <section class="item-category" id="other-category">
            <h2>Other Essentials</h2>
            </section>

        <section class="add-item-section">
            <h2>Add New Item</h2>
            <div class="add-item-form">
                <input type="text" id="newItemName" placeholder="Item name (e.g., Bookshelf)">
                <div class="price-input-wrapper">
                    <span class="currency">₹</span>
                    <input type="number" id="newItemPrice" placeholder="Price (optional)">
                </div>
                <button id="addItemButton" class="btn primary-btn">Add</button>
            </div>
            <div id="custom-items" class="custom-items-list">
                </div>
        </section>
    </main>

    <footer class="app-footer">
        <div class="total-price-display">
            Total Price: <span class="currency">₹</span><span id="totalPrice">0</span>
        </div>
        <nav class="bottom-navbar">
            <button id="saveButton" class="nav-btn">
                <i class="fas fa-save"></i>
                <span>Save</span>
            </button>
            <button id="totalSummaryButton" class="nav-btn">
                <i class="fas fa-list-alt"></i>
                <span>Total</span>
            </button>
            <button id="resetButton" class="nav-btn">
                <i class="fas fa-sync-alt"></i>
                <span>Reset</span>
            </button>
        </nav>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const appliancesCategory = document.getElementById('appliances-category');
            const kitchenCategory = document.getElementById('kitchen-category');
            const otherCategory = document.getElementById('other-category');
            const totalPriceSpan = document.getElementById('totalPrice');
            const newItemNameInput = document.getElementById('newItemName');
            const newItemPriceInput = document.getElementById('newItemPrice');
            const addItemButton = document.getElementById('addItemButton');
            const customItemsContainer = document.getElementById('custom-items');
            const resetButton = document.getElementById('resetButton');
            const saveButton = document.getElementById('saveButton');
            const totalSummaryButton = document.getElementById('totalSummaryButton');
            const listNavigation = document.getElementById('listNavigation');
            let addListBtn; // Declared here, will be assigned after initial buttons are created

            let currentTotalPrice = 0;
            let customItemCounter = 0; // To give unique IDs to custom items
            let activeListKey = 'list1'; // Default active list

            // --- Pre-defined item list (This list remains the source for initial item data) ---
            const predefinedItems = [
                // Appliances
                { id: 'induction', name: 'Induction', price: 3000, category: 'appliances', type: 'appliance' },
                { id: 'refrigerator', name: 'Refrigerator', price: 25000, category: 'appliances', type: 'appliance' },
                { id: 'washingMachine', name: 'Washing Machine', price: 30000, category: 'appliances', type: 'appliance' },
                { id: 'inverter', name: 'Inverter', price: 25000, category: 'appliances', type: 'appliance' },
                { id: 'coolerAc', name: 'Cooler / AC', price: null, category: 'appliances', type: 'appliance' }, // Price to be entered by user

                // Kitchen & Utensils
                { id: 'cooker', name: 'Cooker', price: 3000, category: 'kitchen' },
                { id: 'teaPan', name: 'Tea Pan', price: 300, category: 'kitchen' },
                { id: 'caneyMilk', name: 'Caney for Milk', price: 400, category: 'kitchen' },
                { id: 'spatula', name: 'Spatula', price: 150, category: 'kitchen' },
                { id: 'frySkimmer', name: 'Fry Skimmer', price: 250, category: 'kitchen' },
                { id: 'knife', name: 'Knife', price: 150, category: 'kitchen' },
                { id: 'spoon', name: 'Spoon', price: 150, category: 'kitchen' },
                { id: 'forkSpoon', name: 'Fork Spoon', price: 150, category: 'kitchen' },
                { id: 'tray', name: 'Tray', price: 250, category: 'kitchen' },
                { id: 'teaCups', name: 'Tea cups', price: 500, category: 'kitchen' },
                { id: 'utensilsStandSteel', name: 'Utensils Stand Steel', price: 2000, category: 'kitchen' },
                { id: 'fourPlate', name: '4 - Plate', price: 500, category: 'kitchen' },
                { id: 'twoSmallPlates', name: '2 - Small Plates', price: 200, category: 'kitchen' },
                { id: 'twoBowl', name: '2 - Bowl', price: 600, category: 'kitchen' },
                { id: 'dinnerSet', name: 'Dinner Set', price: 3500, category: 'kitchen' },
                { id: 'juicerMixer', name: 'Juicer / Mixer (Sujata)', price: 5500, category: 'kitchen' },
                { id: 'grater', name: 'Grater', price: 250, category: 'kitchen' },
                { id: 'chopper', name: 'Chopper', price: 250, category: 'kitchen' },
                { id: 'gasStove', name: 'Gas Stove (2 burner)', price: 4000, category: 'kitchen' },
                { id: 'sixBowlSteel', name: '6 - Bowl steel', price: 600, category: 'kitchen' },
                { id: 'sixPlateSteel', name: '6 - Plate steel', price: 600, category: 'kitchen' },
                { id: 'glassSteel', name: 'glass steel', price: 600, category: 'kitchen' },
                { id: 'jug', name: 'Jug', price: 500, category: 'kitchen' },
                { id: 'masalaBox', name: 'Masala Box', price: 250, category: 'kitchen' },

                // Other Essentials
                { id: 'dustbin', name: 'Dustbin', price: 250, category: 'other' },
            ];

            // --- Local Storage Management ---
            const LOCAL_STORAGE_PREFIX = 'homeEssentials_';

            const saveCurrentListState = () => {
                const listState = {
                    items: [], // Stores state of predefined items
                    customItems: [] // Stores custom added items
                };

                // Capture state of ALL items currently in the DOM
                document.querySelectorAll('.item-row').forEach(row => {
                    const itemId = row.dataset.itemId;
                    const checkbox = row.querySelector('.item-checkbox');
                    const priceInput = row.querySelector('.item-price-input');
                    const itemType = row.dataset.itemType;

                    const priceValue = priceInput.value.trim() === '' ? null : parseFloat(priceInput.value);

                    if (itemType === 'custom') {
                        listState.customItems.push({
                            id: itemId,
                            name: row.querySelector('.item-name').textContent,
                            price: priceValue,
                            checked: checkbox.checked
                        });
                    } else { // Predefined item
                        listState.items.push({
                            id: itemId,
                            price: priceValue, // Save current price input value (even if null or modified from default)
                            checked: checkbox.checked
                        });
                    }
                });
                localStorage.setItem(LOCAL_STORAGE_PREFIX + activeListKey, JSON.stringify(listState));
                console.log(`State saved for ${activeListKey}`);
            };

            const loadListState = (listKey) => {
                currentTotalPrice = 0;

                // Clear all current items (predefined and custom)
                const clearCategory = (categoryElement) => {
                    Array.from(categoryElement.children).forEach(child => {
                        if (child.tagName.toLowerCase() !== 'h2') { // Keep the H2 category title
                            child.remove();
                        }
                    });
                }
                clearCategory(appliancesCategory);
                clearCategory(kitchenCategory);
                clearCategory(otherCategory);
                customItemsContainer.innerHTML = '';
                customItemCounter = 0; // Reset for new custom items IDs

                const savedState = localStorage.getItem(LOCAL_STORAGE_PREFIX + listKey);

                // --- First, load predefined items as they are in the `predefinedItems` array ---
                // This ensures all original items are available, even if not saved or unchecked.
                predefinedItems.forEach(item => {
                    const itemRow = createItemRow(item);
                    itemRow.dataset.itemType = 'predefined';
                    if (item.category === 'appliances') {
                        appliancesCategory.appendChild(itemRow);
                    } else if (item.category === 'kitchen') {
                        kitchenCategory.appendChild(itemRow);
                    } else if (item.category === 'other') {
                        otherCategory.appendChild(itemRow);
                    }
                });

                // --- Then, apply saved state on top of the predefined items ---
                if (savedState) {
                    const parsedState = JSON.parse(savedState);

                    // Apply saved state to predefined items
                    parsedState.items.forEach(savedItem => {
                        const itemRow = document.querySelector(`[data-item-id="${savedItem.id}"][data-item-type="predefined"]`);
                        if (itemRow) {
                            const checkbox = itemRow.querySelector('.item-checkbox');
                            const priceInput = itemRow.querySelector('.item-price-input');

                            checkbox.checked = savedItem.checked;

                            // Update price input and data attribute
                            if (savedItem.price !== null) {
                                priceInput.value = savedItem.price;
                                itemRow.dataset.itemPrice = savedItem.price;
                                itemRow.dataset.lastValidPrice = savedItem.price; // Set lastValidPrice for calculations
                            } else {
                                priceInput.value = '';
                                itemRow.dataset.itemPrice = null;
                                itemRow.dataset.lastValidPrice = 0;
                            }

                            // If this item is checked, add its price to the total
                            if (checkbox.checked) {
                                const price = parseFloat(itemRow.dataset.itemPrice);
                                if (!isNaN(price) && price > 0) {
                                    currentTotalPrice += price;
                                }
                            }
                        }
                    });

                    // Load custom items
                    parsedState.customItems.forEach(customItemData => {
                        // Ensure unique IDs for loaded custom items (important if list was emptied or if multiple custom items)
                        const currentMaxCustomId = parseInt((customItemData.id || 'custom-0').split('-')[1]);
                        if (!isNaN(currentMaxCustomId)) {
                             customItemCounter = Math.max(customItemCounter, currentMaxCustomId);
                        }

                        const customItem = {
                            id: customItemData.id,
                            name: customItemData.name,
                            price: customItemData.price,
                            category: 'custom',
                            type: 'custom',
                            defaultChecked: customItemData.checked
                        };
                        const itemRow = createItemRow(customItem);
                        customItemsContainer.appendChild(itemRow);

                        // If custom item is checked, add its price to the total
                        const checkbox = itemRow.querySelector('.item-checkbox');
                        if(checkbox.checked) {
                             const price = parseFloat(itemRow.dataset.itemPrice);
                             if (!isNaN(price) && price > 0) {
                                 currentTotalPrice += price;
                             }
                        }
                    });
                     // Increment customItemCounter AFTER loading all to ensure new custom IDs are unique
                    customItemCounter++;
                }
                updateTotal();
                console.log(`State loaded for ${activeListKey}`);
            };

            // --- UI Functions ---
            const updateTotal = () => {
                totalPriceSpan.textContent = currentTotalPrice.toLocaleString('en-IN'); // Format for Indian Rupees
            };

            // Function to create an item row
            const createItemRow = (item) => {
                const itemRow = document.createElement('div');
                itemRow.className = `item-row ${item.type === 'custom' ? 'custom-item-row' : ''}`;
                itemRow.dataset.itemId = item.id;
                itemRow.dataset.itemType = item.type || 'predefined'; // Set data type
                itemRow.dataset.itemPrice = item.price; // Store price as data attribute
                itemRow.dataset.lastValidPrice = (item.price !== null && !isNaN(item.price)) ? item.price : 0; // Initialize lastValidPrice

                const checkboxId = `item-${item.id}`;
                const initialPriceValue = item.price !== null ? item.price : '';
                // Predefined items with a price are readonly, custom items and predefined items with null price are editable
                const isPriceReadonly = item.price !== null && item.type !== 'custom';

                itemRow.innerHTML = `
                    <label for="${checkboxId}" class="item-checkbox-label">
                        <input type="checkbox" id="${checkboxId}" class="item-checkbox" ${item.defaultChecked ? 'checked' : ''}>
                        <span class="custom-checkbox"></span>
                        <span class="item-name">${item.name}</span>
                    </label>
                    <div class="price-input-wrapper">
                        <span class="currency">₹</span>
                        <input type="number"
                               class="item-price-input"
                               value="${initialPriceValue}"
                               placeholder="${item.price === null || item.type === 'custom' ? 'Price (optional)' : ''}"
                               ${isPriceReadonly ? 'readonly' : ''}>
                    </div>
                    ${item.type === 'custom' ? '<button class="delete-item-btn"><i class="fas fa-trash-alt"></i></button>' : ''}
                `;

                const checkbox = itemRow.querySelector(`#${checkboxId}`);
                const priceInput = itemRow.querySelector('.item-price-input');
                const deleteButton = itemRow.querySelector('.delete-item-btn');

                checkbox.addEventListener('change', () => {
                    const newPrice = parseFloat(priceInput.value);
                    const currentItemPrice = isNaN(newPrice) ? 0 : newPrice; // Treat empty/invalid price as 0 for calculation

                    if (checkbox.checked) {
                        currentTotalPrice += currentItemPrice;
                        itemRow.dataset.lastValidPrice = currentItemPrice; // Update last valid price on check
                    } else {
                        currentTotalPrice -= currentItemPrice;
                        itemRow.dataset.lastValidPrice = 0; // Reset last valid price on uncheck
                    }
                    updateTotal();
                    saveCurrentListState();
                });

                priceInput.addEventListener('input', () => {
                    const oldPrice = parseFloat(itemRow.dataset.lastValidPrice || 0);
                    const currentInputPrice = parseFloat(priceInput.value);

                    // Update data-item-price attribute with the current input value (numeric or null)
                    itemRow.dataset.itemPrice = priceInput.value.trim() === '' ? null : currentInputPrice;

                    if (checkbox.checked) {
                        if (!isNaN(currentInputPrice)) { // If input is a number (even 0 or negative for now)
                            currentTotalPrice = currentTotalPrice - oldPrice + currentInputPrice;
                            itemRow.dataset.lastValidPrice = currentInputPrice; // Update last valid price
                        } else { // Input is not a number (e.g., deleted text)
                            currentTotalPrice -= oldPrice;
                            itemRow.dataset.lastValidPrice = 0; // Reset last valid price
                        }
                    }
                    updateTotal();
                    saveCurrentListState();
                });

                priceInput.addEventListener('blur', () => {
                    const value = priceInput.value.trim();
                    if (value !== '') {
                        const numericValue = parseFloat(value);
                        if (isNaN(numericValue) || numericValue < 0) {
                            alert('Please enter a valid non-negative number for the price, or leave it empty.');
                            priceInput.value = ''; // Clear invalid input
                            itemRow.dataset.itemPrice = null;
                            itemRow.dataset.lastValidPrice = 0;
                            if (checkbox.checked) {
                                checkbox.checked = false; // Uncheck if price becomes invalid
                                // Price was already subtracted by input event if checkbox was checked
                            }
                        } else {
                            itemRow.dataset.itemPrice = numericValue;
                            itemRow.dataset.lastValidPrice = numericValue;
                            // Re-evaluate total if checkbox is checked and price was changed from invalid/empty to valid
                            if (checkbox.checked) {
                                // If the checkbox was already checked, the input event handler would have updated total.
                                // If it was unchecked, and user makes valid input and then checks it, it will be added.
                            }
                        }
                    } else { // Input is empty
                        itemRow.dataset.itemPrice = null;
                        itemRow.dataset.lastValidPrice = 0;
                        // If checkbox was checked, price was already removed by input event
                    }
                    updateTotal();
                    saveCurrentListState();
                });

                if (deleteButton) {
                    deleteButton.addEventListener('click', () => {
                        if (checkbox.checked) {
                            const price = parseFloat(priceInput.value) || 0;
                            currentTotalPrice -= price;
                        }
                        itemRow.remove();
                        updateTotal();
                        saveCurrentListState();
                    });
                }

                return itemRow;
            };

            // --- List Navigation Logic ---
            let listCounter = 0; // Will be updated to max existing list number + 1

            const createListButton = (listName, key, isActive = false) => {
                const button = document.createElement('button');
                button.className = `list-btn ${isActive ? 'active' : ''}`;
                button.dataset.list = key;
                button.textContent = listName;
                listNavigation.insertBefore(button, addListBtn);

                button.addEventListener('click', () => {
                    switchList(key);
                });
                return button;
            };

            const switchList = (newListKey) => {
                saveCurrentListState(); // Save old list state

                // Deactivate current active button
                document.querySelector(`.list-btn.active`)?.classList.remove('active');

                // Activate new button
                document.querySelector(`[data-list="${newListKey}"]`)?.classList.add('active');

                activeListKey = newListKey;
                loadListState(activeListKey);
                localStorage.setItem('activeList', activeListKey); // Save which list was last active
            };

            const initializeListNavigation = () => {
                // Initial lists (List 1, List 2, List 3)
                const initialListKeys = ['list1', 'list2', 'list3'];
                initialListKeys.forEach((key, index) => {
                    createListButton(`List ${index + 1}`, key);
                });

                // Add "Add List" button
                addListBtn = document.createElement('button');
                addListBtn.id = 'addListBtn';
                addListBtn.className = 'list-btn';
                addListBtn.innerHTML = '<i class="fas fa-plus"></i>';
                listNavigation.appendChild(addListBtn);

                addListBtn.addEventListener('click', () => {
                    listCounter++; // Increment counter for new list number
                    const newListKey = `list${listCounter}`;
                    createListButton(`List ${listCounter}`, newListKey, true); // Create and activate
                    switchList(newListKey);
                });

                // Discover existing lists from local storage and create buttons for them
                let maxExistingListNum = 3; // Start from 3 as list1,2,3 are default
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(LOCAL_STORAGE_PREFIX)) {
                        const listId = key.replace(LOCAL_STORAGE_PREFIX, '');
                        // If it's a "listN" format and not one of the initial ones already created
                        if (listId.startsWith('list') && !initialListKeys.includes(listId)) {
                            const listNum = parseInt(listId.replace('list', ''));
                            if (!isNaN(listNum)) {
                                createListButton(`List ${listNum}`, listId);
                                maxExistingListNum = Math.max(maxExistingListNum, listNum);
                            }
                        }
                    }
                }
                listCounter = maxExistingListNum; // Ensure new lists start from the next number

                // Set initial active list based on saved preference or default to list1
                const storedActiveList = localStorage.getItem('activeList');
                if (storedActiveList && document.querySelector(`[data-list="${storedActiveList}"]`)) {
                    switchList(storedActiveList);
                } else {
                    switchList('list1'); // Default to list1
                }
            };


            // --- Event Listeners ---
            addItemButton.addEventListener('click', () => {
                const name = newItemNameInput.value.trim();
                const price = newItemPriceInput.value.trim() === '' ? null : parseFloat(newItemPriceInput.value);

                if (!name) {
                    alert('Please enter an item name.');
                    return;
                }
                // If price is entered, validate it
                if (newItemPriceInput.value.trim() !== '' && (isNaN(price) || price < 0)) {
                    alert('Please enter a valid non-negative price, or leave it empty.');
                    return;
                }

                customItemCounter++;
                const customItem = {
                    id: `custom-${customItemCounter}`,
                    name: name,
                    price: price,
                    category: 'custom',
                    type: 'custom',
                    defaultChecked: true // Auto-check new items
                };

                const itemRow = createItemRow(customItem);
                customItemsContainer.appendChild(itemRow);

                // Manually trigger change for the newly added item's checkbox
                // This ensures its price is immediately added to total
                const newCheckbox = itemRow.querySelector('.item-checkbox');
                if (newCheckbox) {
                    newCheckbox.checked = true; // Ensure it's checked
                    const event = new Event('change');
                    newCheckbox.dispatchEvent(event);
                }

                newItemNameInput.value = '';
                newItemPriceInput.value = '';
                // updateTotal() and saveCurrentListState() are called by the checkbox change event
            });

            resetButton.addEventListener('click', () => {
                if (confirm(`Are you sure you want to reset the current list (${activeListKey})? All selections and custom items will be cleared.`)) {
                    // This is for a full reset of the current list's UI and data
                    currentTotalPrice = 0;
                    updateTotal();

                    const clearCategory = (categoryElement) => {
                        Array.from(categoryElement.children).forEach(child => {
                            if (child.tagName.toLowerCase() !== 'h2') {
                                child.remove();
                            }
                        });
                    }

                    clearCategory(appliancesCategory);
                    clearCategory(kitchenCategory);
                    clearCategory(otherCategory);
                    customItemsContainer.innerHTML = '';
                    customItemCounter = 0;

                    // Re-render predefined items in their initial (unchecked, default price) state
                    predefinedItems.forEach(item => {
                        const itemRow = createItemRow(item);
                        itemRow.dataset.itemType = 'predefined';
                        if (item.category === 'appliances') {
                            appliancesCategory.appendChild(itemRow);
                        } else if (item.category === 'kitchen') {
                            kitchenCategory.appendChild(itemRow);
                        } else if (item.category === 'other') {
                            otherCategory.appendChild(itemRow);
                        }
                    });
                    saveCurrentListState(); // Save the now empty/defaulted state
                }
            });


            saveButton.addEventListener('click', () => {
                saveCurrentListState();
                localStorage.setItem('activeList', activeListKey); // Save current active list
                alert(`List "${activeListKey}" saved successfully!`);
            });

            totalSummaryButton.addEventListener('click', () => {
                alert(`Your current total for ${activeListKey} is: ₹${currentTotalPrice.toLocaleString('en-IN')}\n\n(This button could show a detailed item-by-item breakdown or navigate to a summary page.)`);
            });

            // --- Initial Load ---
            initializeListNavigation();
            // loadListState for the activeListKey is called inside initializeListNavigation
        });
    </script>
</body>
</html>
